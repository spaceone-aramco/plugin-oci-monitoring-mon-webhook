# SpaceONE OCI 웹훅 연동 사용자 가이드

## 📋 개요

본 가이드는 Oracle Cloud Infrastructure(OCI) Monitoring에서 발생하는 알람을 SpaceONE Alert Manager로 수신하기 위한 완전한 설정 방법을 제공합니다.

## 🏗️ 연동 아키텍처

```
OCI Monitoring → Alarm → Notification Topic → Subscription → SpaceONE Webhook → Alert Manager
```

### 주요 구성 요소
1. **OCI Monitoring**: 모니터링 지표 및 알람 정책 관리
2. **OCI Notification Service**: SpaceONE으로 알림 전달하는 서비스
3. **SpaceONE Webhook**: OCI 알림을 수신하는 엔드포인트
4. **SpaceONE Alert Manager**: 수신된 알림의 통합 관리 및 처리

## 🚀 설정 단계

### 1단계: SpaceONE Alert Service 생성

#### 1.1 Alert Service 생성 페이지 이동
1. SpaceONE 콘솔에서 **Alert Manager** 서비스로 이동
2. 우측 상단의 **[생성]** 버튼 클릭

#### 1.2 기본 정보 입력
다음 정보를 입력합니다:

| 필드 | 설명 | 필수 여부 |
|------|------|-----------|
| **이름** | Alert Service를 구분할 수 있는 이름 | 필수 |
| **키(Key)** | 시스템에서 사용할 고유 식별자 | 필수 |
| **멤버** | Alert Service와 연관된 멤버 지정 | 선택 |
| **설명** | Alert Service에 대한 상세 설명 | 선택 |

#### 1.3 웹훅 설정
1. **연결할 웹훅 선택**: OCI 연동용 웹훅 선택
2. **웹훅 정보 확인**: 웹훅 이름과 버전 확인
3. **웹훅 URL 획득**: 생성 완료 후 제공되는 웹훅 URL 복사 및 보관

> ⚠️ **중요**: 웹훅 URL은 다음 단계에서 OCI 설정 시 필요하므로 안전하게 보관해야 합니다.

### 2단계: OCI Monitoring 설정

#### 2.1 OCI 콘솔 접속 및 서비스 선택
1. OCI Console에 로그인
2. 왼쪽 메뉴에서 **"Observability & Management"** → **"Monitoring"** 선택

#### 2.2 Alarm 생성
1. **"Alarms"** 탭 선택
2. **"Create Alarm"** 버튼 클릭

#### 2.3 모니터링 지표 설정
본 예시에서는 Compute Instance CPU 사용량 모니터링을 기준으로 설명합니다:

1. **Alarm Name**: 알람 이름 입력 (예: "High CPU Usage Alert")
2. **Compartment**: 모니터링할 구획(Compartment) 선택
3. **Metric Description**: 
   - **Metric Namespace**: `oci_computeagent`
   - **Metric Name**: `CpuUtilization`
   - **Resource Group**: 모니터링할 인스턴스 선택
4. **Interval**: 평가 간격 설정 (예: 1분)
5. **Statistic**: 통계 방법 선택 (예: Mean, Max)

#### 2.4 임계값 및 조건 설정
1. **Operator**: 비교 연산자 선택 (예: "greater than")
2. **Value**: 임계값 입력 (예: 80)
3. **Trigger Delay Minutes**: 알람 발생 지연 시간 (예: 5분)

#### 2.5 알람 생성 완료
1. **"Create Alarm"** 클릭하여 알람 생성
2. 생성된 알람이 목록에 나타나는지 확인

### 3단계: OCI Notification Service 설정

#### 3.1 Notification Topic 생성
1. OCI Console에서 **"Observability & Management"** → **"Notifications"** 선택
2. **"Topics"** 탭에서 **"Create Topic"** 클릭
3. **Topic 정보 입력**:
   - **Name**: 토픽 이름 (예: "SpaceONE-Webhook-Topic")
   - **Description**: 토픽 설명
4. **"Create"** 클릭하여 토픽 생성

#### 3.2 Subscription 생성
1. 생성된 토픽을 선택
2. **"Create Subscription"** 클릭
3. **Subscription 정보 입력**:
   - **Protocol**: **"HTTPS"** 선택
   - **Endpoint**: 1단계에서 획득한 SpaceONE 웹훅 URL 입력
4. **"Create"** 클릭하여 구독 생성

#### 3.3 Subscription 확인
1. OCI에서 SpaceONE 웹훅 URL로 확인 요청 전송
2. SpaceONE Alert Manager에서 확인 요청 수신 확인
3. 구독 상태가 **"Confirmed"**로 변경되는지 확인

### 4단계: Alarm과 Notification 연결

#### 4.1 기존 Alarm 편집
1. **"Monitoring"** → **"Alarms"**에서 생성한 알람 선택
2. **"Edit"** 버튼 클릭

#### 4.2 Notification 설정
1. **"Notifications"** 섹션에서 **"Add Destination"** 클릭
2. **Destination Type**: **"Topic"** 선택
3. **Topic**: 3단계에서 생성한 토픽 선택
4. **"Save Changes"** 클릭

### 5단계: SpaceONE에서 웹훅 수신 확인

#### 5.1 실제 알림 테스트
1. OCI에서 설정한 임계치를 의도적으로 초과시켜 알림 발생
2. SpaceONE Alert Manager에서 해당 알림 수신 확인

#### 5.2 알림 상세 정보 확인
1. 수신된 알림 클릭
2. OCI에서 전달된 상세 정보 확인:
   - 알림 발생 시간
   - 임계치 초과 값
   - 영향받은 리소스 정보
   - 알림 심각도

## 📊 지원되는 OCI 모니터링 지표

### Compute Instance
- CPU 사용률 (`CpuUtilization`)
- 메모리 사용률 (`MemoryUtilization`)
- 디스크 I/O (`DiskBytesRead`, `DiskBytesWritten`)
- 네트워크 트래픽 (`NetworksBytesIn`, `NetworksBytesOut`)

### Load Balancer
- 요청 수 (`RequestCount`)
- 응답 시간 (`ResponseTime`)
- 활성 연결 수 (`ActiveConnections`)

### Database
- CPU 사용률 (`CpuUtilization`)
- 메모리 사용률 (`MemoryUtilization`)
- 연결 수 (`ConnectionCount`)
- 쿼리 성능 지표

### Object Storage
- 버킷 크기 (`BucketSizeBytes`)
- 요청 수 (`RequestCount`)
- 오류율 (`ErrorRate`)

## 🛡️ 보안 설정

### OCI IAM 권한 설정
다음 권한이 필요합니다:

```
Allow group webhook-users to manage alarms in compartment monitoring
Allow group webhook-users to manage ons-topics in compartment monitoring
Allow group webhook-users to manage ons-subscriptions in compartment monitoring
Allow group webhook-users to read metrics in compartment monitoring
```

### 네트워크 보안
- **HTTPS 사용**: 웹훅 URL은 반드시 HTTPS 프로토콜 사용
- **IP 화이트리스트**: OCI IP 대역에서만 웹훅 수신 허용
- **인증 토큰**: 가능한 경우 웹훅 인증 토큰 설정

## 🔧 문제 해결

### 일반적인 문제와 해결 방법

#### 1. Subscription 확인 실패
**증상**: OCI에서 Subscription 상태가 "Pending" 상태로 유지

**해결 방법**:
- SpaceONE 웹훅 URL 정확성 확인
- 네트워크 방화벽 설정 확인
- SpaceONE Alert Service 상태 확인
- OCI Notification Service의 확인 요청 로그 확인

#### 2. 알림 미수신
**증상**: 임계치 초과했으나 SpaceONE에서 알림 미수신

**해결 방법**:
- OCI Alarm 상태 확인 (Firing/OK)
- Notification Topic과 Subscription 연결 상태 확인
- Alarm과 Topic 연결 설정 재확인
- SpaceONE 웹훅 로그 확인

#### 3. 중복 알림 수신
**증상**: 동일한 이벤트에 대해 여러 번 알림 수신

**해결 방법**:
- OCI Alarm의 중복 설정 확인
- Trigger Delay 설정 검토
- SpaceONE Alert Manager의 중복 제거 설정 확인

#### 4. 권한 관련 오류
**증상**: OCI에서 Monitoring 또는 Notification 서비스 접근 불가

**해결 방법**:
- IAM 정책에서 필요한 권한 확인
- Compartment 접근 권한 확인
- 사용자 그룹 권한 설정 검토

## 📈 모범 사례

### 1. 알림 정책 설계
- **적절한 임계값 설정**: 너무 민감하거나 둔감하지 않은 임계값 설정
- **Trigger Delay 활용**: 일시적인 스파이크로 인한 불필요한 알림 방지
- **심각도 분류**: 알림의 중요도에 따른 적절한 분류

### 2. 모니터링 및 유지보수
- **정기적인 테스트**: 웹훅 연동 상태 정기 확인
- **로그 모니터링**: SpaceONE에서 웹훅 수신 로그 모니터링
- **알림 정책 검토**: 비즈니스 요구사항 변경에 따라 알림 정책 업데이트

### 3. OCI 특화 고려사항
- **Compartment 권한**: 적절한 Compartment 권한 설정
- **리전별 설정**: 멀티 리전 환경에서의 알림 설정 고려
- **비용 최적화**: 불필요한 알림 최소화로 비용 절감

## 📞 지원 및 문의

### 추가 도움이 필요한 경우
- **기술 문서**: [OCI 웹훅 연동 기술 명세서](technical/OCI_웹훅_연동_기술_명세서.md)
- **개발 가이드**: [개발 환경 가이드](development/개발_환경_가이드.md)
- **이슈 리포트**: GitHub Issues를 통한 문제 신고

### 참고 자료
- [OCI Monitoring 서비스 문서](https://docs.oracle.com/en-us/iaas/Content/Monitoring/home.htm)
- [OCI Notification 서비스 문서](https://docs.oracle.com/en-us/iaas/Content/Notification/home.htm)
- [SpaceONE Alert Manager 공식 문서](https://www.spaceone.megazone.io/products/alert-manager)

---

**마지막 업데이트**: 2024년 1월 28일  
**문서 버전**: 1.0.0
