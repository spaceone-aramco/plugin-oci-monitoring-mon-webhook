# SpaceONE OCI ëª¨ë‹ˆí„°ë§ ì›¹í›… í”ŒëŸ¬ê·¸ì¸ ì†ŒìŠ¤ì½”ë“œ ë¶„ì„ ë¬¸ì„œ

## ğŸ“‹ ê°œìš”

ë³¸ ë¬¸ì„œëŠ” SpaceONE OCI ëª¨ë‹ˆí„°ë§ ì›¹í›… í”ŒëŸ¬ê·¸ì¸ì˜ ì „ì²´ ì†ŒìŠ¤ì½”ë“œ êµ¬ì¡°ì™€ ê° ì»´í¬ë„ŒíŠ¸ì˜ ìƒì„¸ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤. ê°œë°œìê°€ ì½”ë“œë¥¼ ì´í•´í•˜ê³  í™•ì¥í•  ìˆ˜ ìˆë„ë¡ ì™„ì „í•œ ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.

## ğŸ—ï¸ í”„ë¡œì íŠ¸ êµ¬ì¡° ê°œìš”

### ì „ì²´ ë””ë ‰í† ë¦¬ êµ¬ì¡°
```
plugin-oci-monitoring-mon-webhook/
â”œâ”€â”€ ğŸ“ src/                          # ì†ŒìŠ¤ì½”ë“œ ë£¨íŠ¸
â”‚   â”œâ”€â”€ setup.py                     # íŒ¨í‚¤ì§€ ì„¤ì • íŒŒì¼
â”‚   â”œâ”€â”€ VERSION                      # ë²„ì „ ì •ë³´ (0.1.3)
â”‚   â””â”€â”€ ğŸ“ spaceone/
â”‚       â””â”€â”€ ğŸ“ monitoring/           # ëª¨ë‹ˆí„°ë§ í”ŒëŸ¬ê·¸ì¸ ë©”ì¸ íŒ¨í‚¤ì§€
â”‚           â”œâ”€â”€ __init__.py
â”‚           â”œâ”€â”€ ğŸ“ conf/             # ì„¤ì • íŒŒì¼ë“¤
â”‚           â”œâ”€â”€ ğŸ“ connector/        # ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ê²°ì
â”‚           â”œâ”€â”€ ğŸ“ error/            # ì˜ˆì™¸ ì²˜ë¦¬ í´ë˜ìŠ¤ë“¤
â”‚           â”œâ”€â”€ ğŸ“ info/             # gRPC ì‘ë‹µ ì •ë³´ í´ë˜ìŠ¤ë“¤
â”‚           â”œâ”€â”€ ğŸ“ interface/        # gRPC ì¸í„°í˜ì´ìŠ¤
â”‚           â”œâ”€â”€ ğŸ“ manager/          # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê´€ë¦¬ìë“¤
â”‚           â”œâ”€â”€ ğŸ“ model/            # ë°ì´í„° ëª¨ë¸ ì •ì˜
â”‚           â””â”€â”€ ğŸ“ service/          # ì„œë¹„ìŠ¤ ë ˆì´ì–´
â”œâ”€â”€ ğŸ“ test/                         # í…ŒìŠ¤íŠ¸ ì½”ë“œ
â”œâ”€â”€ ğŸ“ docs/                         # ë¬¸ì„œ
â”œâ”€â”€ ğŸ“ pkg/                          # íŒ¨í‚¤ì§€ ì˜ì¡´ì„±
â”œâ”€â”€ Dockerfile                       # Docker ì»¨í…Œì´ë„ˆ ì„¤ì •
â”œâ”€â”€ Makefile                         # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
â””â”€â”€ README.md                        # í”„ë¡œì íŠ¸ ì„¤ëª…
```

## ğŸ”§ í•µì‹¬ ì»´í¬ë„ŒíŠ¸ ë¶„ì„

### 1. íŒ¨í‚¤ì§€ ì„¤ì • ë° ë©”íƒ€ë°ì´í„°

#### setup.py
```python
# íŒ¨í‚¤ì§€ ê¸°ë³¸ ì •ë³´
name='plugin-google-monitoring-mon-webhook'  # ì£¼ì˜: Google ì´ë¦„ ì‚¬ìš© ì¤‘ (OCIë¡œ ë³€ê²½ í•„ìš”)
version='0.1.3'                              # í˜„ì¬ ë²„ì „
description='Google Monitoring Webhook'      # ì„¤ëª… (OCIë¡œ ë³€ê²½ í•„ìš”)

# ì˜ì¡´ì„±
install_requires=[
    'spaceone-api',    # SpaceONE API ë¼ì´ë¸ŒëŸ¬ë¦¬
    'schematics'       # ë°ì´í„° ê²€ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬
]
```

**ì£¼ìš” ì´ìŠˆ**: 
- íŒ¨í‚¤ì§€ëª…ê³¼ ì„¤ëª…ì´ ì—¬ì „íˆ Google Monitoring ê¸°ì¤€ìœ¼ë¡œ ë˜ì–´ ìˆìŒ
- OCI ëª¨ë‹ˆí„°ë§ìœ¼ë¡œ ì—…ë°ì´íŠ¸ í•„ìš”

#### ì˜ì¡´ì„± ê´€ë¦¬
```
pkg/pip_requirements.txt:
- schematics  # ë°ì´í„° ëª¨ë¸ ê²€ì¦ìš©
```

### 2. ì„¤ì • ë° êµ¬ì„± (conf/)

#### proto_conf.py - gRPC ì„œë¹„ìŠ¤ ë“±ë¡
```python
PROTO = {
    'spaceone.monitoring.interface.grpc.webhook': ['Webhook'],  # ì›¹í›… ì„œë¹„ìŠ¤
    'spaceone.monitoring.interface.grpc.event': ['Event'],     # ì´ë²¤íŠ¸ ì„œë¹„ìŠ¤
}
```

#### global_conf.py - ì „ì—­ ì„¤ì •
```python
CONNECTORS = {
    'GoogleCloudConnector': {}  # ì£¼ì˜: Google ì»¤ë„¥í„° ì„¤ì • (OCIë¡œ ë³€ê²½ í•„ìš”)
}

LOG = {
    'filters': {
        'masking': {
            'rules': {
                'Webhook.verify': ['secret_data']  # ë¯¼ê° ë°ì´í„° ë§ˆìŠ¤í‚¹
            }
        }
    }
}
```

### 3. gRPC ì¸í„°í˜ì´ìŠ¤ ë ˆì´ì–´ (interface/)

#### webhook.py - ì›¹í›… gRPC ì¸í„°í˜ì´ìŠ¤
```python
from spaceone.api.monitoring.plugin import webhook_pb2, webhook_pb2_grpc
from spaceone.core.pygrpc import BaseAPI

class Webhook(BaseAPI, webhook_pb2_grpc.WebhookServicer):
    """ì›¹í›… gRPC ì„œë¹„ìŠ¤ êµ¬í˜„"""
    
    pb2 = webhook_pb2
    pb2_grpc = webhook_pb2_grpc

    def init(self, request, context):
        """í”ŒëŸ¬ê·¸ì¸ ì´ˆê¸°í™” API"""
        params, metadata = self.parse_request(request, context)
        
        with self.locator.get_service('WebhookService', metadata) as webhook_service:
            return self.locator.get_info('WebhookPluginInfo', webhook_service.init(params))

    def verify(self, request, context):
        """ì›¹í›… ê²€ì¦ API"""
        params, metadata = self.parse_request(request, context)
        
        with self.locator.get_service('WebhookService', metadata) as webhook_service:
            webhook_service.verify(params)
            return self.locator.get_info('EmptyInfo')
```

**í•µì‹¬ íŠ¹ì§•**:
- SpaceONE í‘œì¤€ gRPC íŒ¨í„´ ì‚¬ìš©
- Service Locator íŒ¨í„´ìœ¼ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¶„ë¦¬
- ìš”ì²­/ì‘ë‹µ íŒŒì‹± ìë™í™”

#### event.py - ì´ë²¤íŠ¸ gRPC ì¸í„°í˜ì´ìŠ¤
```python
from spaceone.api.monitoring.plugin import event_pb2, event_pb2_grpc
from spaceone.core.pygrpc import BaseAPI

class Event(BaseAPI, event_pb2_grpc.EventServicer):
    """ì´ë²¤íŠ¸ ì²˜ë¦¬ gRPC ì„œë¹„ìŠ¤"""
    
    pb2 = event_pb2
    pb2_grpc = event_pb2_grpc

    def parse(self, request, context):
        """ì´ë²¤íŠ¸ íŒŒì‹± API"""
        params, metadata = self.parse_request(request, context)
        
        with self.locator.get_service('EventService', metadata) as event_service:
            return self.locator.get_info('EventsInfo', event_service.parse(params))
```

### 4. ì„œë¹„ìŠ¤ ë ˆì´ì–´ (service/)

#### webhook_service.py - ì›¹í›… ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
```python
import logging
from spaceone.core.service import *
from spaceone.monitoring.error import *

@authentication_handler
@authorization_handler
@event_handler
class WebhookService(BaseService):
    """ì›¹í›… ì„œë¹„ìŠ¤ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§"""

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    @check_required(['options'])
    def init(self, params):
        """ì›¹í›… ì´ˆê¸°í™”
        
        Args:
            params (dict): {
                'options': dict  # ì´ˆê¸°í™” ì˜µì…˜
            }
        
        Returns:
            dict: {'metadata': {}}  # í”ŒëŸ¬ê·¸ì¸ ë©”íƒ€ë°ì´í„°
        """
        return {'metadata': {}}

    @transaction
    @check_required(['options'])
    def verify(self, params):
        """ì›¹í›… ê²€ì¦
        
        Args:
            params (dict): {
                'options': dict  # ê²€ì¦ ì˜µì…˜
            }
        """
        pass  # í˜„ì¬ êµ¬í˜„ë˜ì§€ ì•ŠìŒ (TODO: OCI ê²€ì¦ ë¡œì§ ì¶”ê°€ í•„ìš”)
```

**ì£¼ìš” íŠ¹ì§•**:
- SpaceONE ë°ì½”ë ˆì´í„° íŒ¨í„´ ì‚¬ìš©
- `@authentication_handler`: ì¸ì¦ ì²˜ë¦¬
- `@authorization_handler`: ê¶Œí•œ ì²˜ë¦¬  
- `@event_handler`: ì´ë²¤íŠ¸ ì²˜ë¦¬
- `@transaction`: íŠ¸ëœì­ì…˜ ê´€ë¦¬
- `@check_required`: í•„ìˆ˜ íŒŒë¼ë¯¸í„° ê²€ì¦

#### event_service.py - ì´ë²¤íŠ¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
```python
import logging
from spaceone.core.service import *
from spaceone.monitoring.manager.event_manager import EventManager

@authentication_handler
@authorization_handler
@event_handler
class EventService(BaseService):
    """ì´ë²¤íŠ¸ ì„œë¹„ìŠ¤ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§"""

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.event_mgr: EventManager = self.locator.get_manager('EventManager')

    @transaction
    @check_required(['options', 'data'])
    def parse(self, params):
        """ì´ë²¤íŠ¸ íŒŒì‹±
        
        Args:
            params (dict): {
                'options': dict,    # íŒŒì‹± ì˜µì…˜
                'data': dict       # ì›ì‹œ ì´ë²¤íŠ¸ ë°ì´í„°
            }
        
        Returns:
            list: íŒŒì‹±ëœ ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸
        """
        raw_data = params.get('data')
        parsed_event = self.event_mgr.parse(raw_data)
        return parsed_event
```

### 5. ë§¤ë‹ˆì € ë ˆì´ì–´ (manager/)

#### event_manager.py - ì´ë²¤íŠ¸ ì²˜ë¦¬ ê´€ë¦¬ì
```python
import logging
import hashlib
import json
from datetime import datetime
from spaceone.core.manager import BaseManager
from spaceone.monitoring.manager.incident_1_2 import Incident_1_2
from spaceone.monitoring.manager.incident import Incident
from spaceone.monitoring.model.event_response_model import EventModel

class EventManager(BaseManager):
    """ì´ë²¤íŠ¸ ì²˜ë¦¬ í•µì‹¬ ë¡œì§"""

    def parse(self, raw_data):
        """ì›ì‹œ ë°ì´í„°ë¥¼ SpaceONE ì´ë²¤íŠ¸ë¡œ ë³€í™˜
        
        Args:
            raw_data (dict): ì›ì‹œ ì›¹í›… ë°ì´í„°
            
        Returns:
            list: ê²€ì¦ëœ ì´ë²¤íŠ¸ ê°ì²´ ë¦¬ìŠ¤íŠ¸
        """
        results = []
        
        # ë²„ì „ë³„ ì²˜ë¦¬ ë¡œì§
        version = raw_data.get('version')
        if version == '1.2':
            inst = Incident_1_2(raw_data.get('incident', {}), version)
        elif version == 'test':
            inst = Incident(raw_data.get('incident', {}), version)
        else:
            # ì§€ì›í•˜ì§€ ì•ŠëŠ” ë²„ì „
            inst = Incident(raw_data.get('incident', {}), version)
            _LOGGER.critical(f'Unsupported version: {version}')
        
        # ì´ë²¤íŠ¸ ë³€í™˜ ë° ê²€ì¦
        event_dict = inst.get_event_dict()
        event_vo = self._check_validity(event_dict)
        results.append(event_vo)
        
        return results

    @staticmethod
    def _check_validity(event_dict):
        """ì´ë²¤íŠ¸ ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
        
        Args:
            event_dict (dict): ì´ë²¤íŠ¸ ë”•ì…”ë„ˆë¦¬
            
        Returns:
            dict: ê²€ì¦ëœ ì´ë²¤íŠ¸ ë°ì´í„°
            
        Raises:
            ERROR_CHECK_VALIDITY: ê²€ì¦ ì‹¤íŒ¨ ì‹œ
        """
        try:
            event_result_model = EventModel(event_dict, strict=False)
            event_result_model.validate()
            return event_result_model.to_native()
        except Exception as e:
            raise ERROR_CHECK_VALIDITY(field=e)
```

**í•µì‹¬ ë¡œì§**:
1. **ë²„ì „ ê°ì§€**: `version` í•„ë“œë¡œ ë°ì´í„° í˜•ì‹ íŒë‹¨
2. **ì¸ì‹œë˜íŠ¸ ì²˜ë¦¬**: ë²„ì „ë³„ ì ì ˆí•œ Incident í´ë˜ìŠ¤ ì„ íƒ
3. **ë°ì´í„° ë³€í™˜**: ì›ì‹œ ë°ì´í„° â†’ SpaceONE ì´ë²¤íŠ¸ í˜•ì‹
4. **ê²€ì¦**: Schematics ëª¨ë¸ë¡œ ë°ì´í„° ìœ íš¨ì„± í™•ì¸

#### incident.py - ê¸°ë³¸ ì¸ì‹œë˜íŠ¸ ì²˜ë¦¬ê¸°
```python
import time
from datetime import datetime

class Incident:
    """Google Cloud Monitoring ì¸ì‹œë˜íŠ¸ ì²˜ë¦¬ (ê¸°ë³¸ ë²„ì „)"""

    def __init__(self, incident_data, version):
        """ì¸ì‹œë˜íŠ¸ ì´ˆê¸°í™”
        
        Args:
            incident_data (dict): ì¸ì‹œë˜íŠ¸ ì›ì‹œ ë°ì´í„°
            version (str): ë°ì´í„° ë²„ì „
        """
        self.event_dict = {}
        self.incident = incident_data
        self.version = version
        
        # ê¸°ë³¸ í•„ë“œ ë§¤í•‘
        self.event_dict['title'] = self._update_title()
        self.event_dict['event_type'] = self._update_event_type(self.incident.get('state', ''))
        self.event_dict['severity'] = self._update_severity(self.incident.get('state', ''))
        self.event_dict['resource'] = self._update_resource()
        self.event_dict['additional_info'] = self._update_additional()
        self.event_dict['occurred_at'] = self._update_occurred_at()
        
        self._update()

    def _update(self):
        """ê¸°ë³¸ í•„ë“œ ë§¤í•‘"""
        map_keys = {
            'incident_id': 'event_key',      # ì¸ì‹œë˜íŠ¸ ID â†’ ì´ë²¤íŠ¸ í‚¤
            'summary': 'description',         # ìš”ì•½ â†’ ì„¤ëª…
            'policy_name': 'rule'            # ì •ì±…ëª… â†’ ê·œì¹™
        }
        
        for source_key, target_key in map_keys.items():
            value = self.incident.get(source_key)
            if value:
                self.event_dict[target_key] = value

    def _update_title(self):
        """ì´ë²¤íŠ¸ ì œëª© ìƒì„±"""
        condition_name = self.incident.get('condition_name', 'no title')
        state = self.incident.get('state', 'unknown')
        return f'{condition_name} ({state})'

    def _update_event_type(self, state):
        """ìƒíƒœ â†’ ì´ë²¤íŠ¸ íƒ€ì… ë§¤í•‘"""
        state_mapping = {
            'OPEN': 'ALERT',      # ì—´ë¦¼ â†’ ì•ŒëŒ
            'open': 'ALERT',      # ì—´ë¦¼ â†’ ì•ŒëŒ  
            'CLOSED': 'RECOVERY', # ë‹«í˜ â†’ ë³µêµ¬
            'closed': 'RECOVERY'  # ë‹«í˜ â†’ ë³µêµ¬
        }
        return state_mapping.get(state, 'ALERT')

    def _update_severity(self, state):
        """ìƒíƒœ â†’ ì‹¬ê°ë„ ë§¤í•‘"""
        severity_mapping = {
            'OPEN': 'ALERT',      # ì—´ë¦¼ â†’ ì•ŒëŒ
            'open': 'ALERT',      # ì—´ë¦¼ â†’ ì•ŒëŒ
            'CLOSED': 'RECOVERY', # ë‹«í˜ â†’ ë³µêµ¬  
            'closed': 'RECOVERY'  # ë‹«í˜ â†’ ë³µêµ¬
        }
        return severity_mapping.get(state, 'NONE')

    def _update_resource(self):
        """ë¦¬ì†ŒìŠ¤ ì •ë³´ ì¶”ì¶œ"""
        return {
            'resource_id': self.incident.get('resource_id', ''),
            'name': self.incident.get('resource_name', ''),
            'resource_type': 'inventory.CloudService'
        }

    def _update_additional(self):
        """ì¶”ê°€ ì •ë³´ ì¶”ì¶œ"""
        additional = {}
        map_keys = {'url': 'url'}
        
        for source_key, target_key in map_keys.items():
            value = self.incident.get(source_key)
            if value:
                additional[target_key] = value
                
        return additional

    def _update_occurred_at(self):
        """ë°œìƒ ì‹œê°„ ì²˜ë¦¬"""
        # í˜„ì¬ êµ¬í˜„ ë¶ˆì™„ì „ (TODO: íƒ€ì„ìŠ¤íƒ¬í”„ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€ í•„ìš”)
        return datetime.utcnow()

    def get_event_dict(self):
        """ë³€í™˜ëœ ì´ë²¤íŠ¸ ë”•ì…”ë„ˆë¦¬ ë°˜í™˜"""
        return self.event_dict
```

#### incident_1_2.py - ë²„ì „ 1.2 ì¸ì‹œë˜íŠ¸ ì²˜ë¦¬ê¸°
```python
from spaceone.monitoring.manager.incident import Incident

class Incident_1_2(Incident):
    """Google Cloud Monitoring ì¸ì‹œë˜íŠ¸ ì²˜ë¦¬ (ë²„ì „ 1.2)"""

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _parse(self):
        """ë²„ì „ 1.2 íŠ¹í™” íŒŒì‹± ë¡œì§"""
        print(self.incident)  # í˜„ì¬ ë””ë²„ê·¸ìš© (TODO: ì‹¤ì œ ë¡œì§ êµ¬í˜„ í•„ìš”)
```

### 6. ë°ì´í„° ëª¨ë¸ ë ˆì´ì–´ (model/)

#### event_response_model.py - ì´ë²¤íŠ¸ ë°ì´í„° ëª¨ë¸
```python
from schematics.models import Model
from schematics.types import DictType, StringType, ModelType, DateTimeType

class ResourceModel(Model):
    """ë¦¬ì†ŒìŠ¤ ì •ë³´ ëª¨ë¸"""
    resource_id = StringType(serialize_when_none=False)    # ë¦¬ì†ŒìŠ¤ ID
    name = StringType(serialize_when_none=False)           # ë¦¬ì†ŒìŠ¤ ì´ë¦„
    resource_type = StringType(serialize_when_none=False)  # ë¦¬ì†ŒìŠ¤ íƒ€ì…

class EventModel(Model):
    """SpaceONE ì´ë²¤íŠ¸ ëª¨ë¸"""
    
    # í•„ìˆ˜ í•„ë“œ
    event_key = StringType(required=True)                  # ì´ë²¤íŠ¸ ê³ ìœ  í‚¤
    title = StringType(required=True)                      # ì´ë²¤íŠ¸ ì œëª©
    
    # ì„ íƒ ì œí•œ í•„ë“œ
    event_type = StringType(
        choices=['RECOVERY', 'ALERT'], 
        default='ALERT'
    )
    severity = StringType(
        choices=['CRITICAL', 'ERROR', 'WARNING', 'INFO', 'NOT_AVAILABLE', 'NONE'], 
        default='NONE'
    )
    
    # ì„ íƒì  í•„ë“œ
    description = StringType(default='')                   # ì´ë²¤íŠ¸ ì„¤ëª…
    rule = StringType(default='')                          # ì•Œë¦¼ ê·œì¹™
    image_url = StringType(default='')                     # ì´ë¯¸ì§€ URL
    
    # ë³µí•© íƒ€ì… í•„ë“œ
    resource = ModelType(ResourceModel)                    # ë¦¬ì†ŒìŠ¤ ì •ë³´
    occurred_at = DateTimeType()                           # ë°œìƒ ì‹œê°„
    additional_info = DictType(StringType(), default={})   # ì¶”ê°€ ì •ë³´
```

**Schematics ê²€ì¦ ê·œì¹™**:
- `required=True`: í•„ìˆ˜ í•„ë“œ ê²€ì¦
- `choices=[...]`: í—ˆìš©ëœ ê°’ë§Œ ì…ë ¥ ê°€ëŠ¥
- `default=...`: ê¸°ë³¸ê°’ ì„¤ì •
- `serialize_when_none=False`: None ê°’ì¼ ë•Œ ì§ë ¬í™” ì œì™¸

### 7. ì •ë³´ ë³€í™˜ ë ˆì´ì–´ (info/)

#### event_info.py - ì´ë²¤íŠ¸ gRPC ì‘ë‹µ ë³€í™˜
```python
import functools
from spaceone.core import utils
from spaceone.api.monitoring.plugin import event_pb2
from spaceone.monitoring.model.event_response_model import EventModel
from spaceone.core.pygrpc.message_type import *

def EventInfo(event_data: EventModel):
    """EventModelì„ gRPC EventInfoë¡œ ë³€í™˜
    
    Args:
        event_data (EventModel): ê²€ì¦ëœ ì´ë²¤íŠ¸ ëª¨ë¸
        
    Returns:
        event_pb2.EventInfo: gRPC ì´ë²¤íŠ¸ ì •ë³´
    """
    info = {
        'event_key': event_data['event_key'],
        'event_type': event_data['event_type'],
        'description': event_data.get('description'),
        'title': event_data['title'],
        'image_url': event_data.get('image_url'),
        'severity': event_data['severity'],
        'resource': change_struct_type(event_data['resource']),           # dict â†’ Struct
        'rule': event_data.get('rule'),
        'occurred_at': utils.datetime_to_iso8601(event_data.get('occurred_at')), # datetime â†’ ISO8601
        'additional_info': change_struct_type(event_data.get('additional_info'))  # dict â†’ Struct
    }
    return event_pb2.EventInfo(**info)

def EventsInfo(event_datas, **kwargs):
    """ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸ë¥¼ gRPC EventsInfoë¡œ ë³€í™˜
    
    Args:
        event_datas (list): ì´ë²¤íŠ¸ ë°ì´í„° ë¦¬ìŠ¤íŠ¸
        
    Returns:
        event_pb2.EventsInfo: gRPC ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸ ì •ë³´
    """
    return event_pb2.EventsInfo(
        results=list(map(functools.partial(EventInfo, **kwargs), event_datas))
    )
```

#### webhook_info.py - ì›¹í›… gRPC ì‘ë‹µ ë³€í™˜
```python
from spaceone.api.monitoring.plugin import webhook_pb2
from spaceone.core.pygrpc.message_type import *

def WebhookPluginInfo(result):
    """ì›¹í›… í”ŒëŸ¬ê·¸ì¸ ì •ë³´ë¥¼ gRPC ë©”ì‹œì§€ë¡œ ë³€í™˜
    
    Args:
        result (dict): í”ŒëŸ¬ê·¸ì¸ ê²°ê³¼ ë°ì´í„°
        
    Returns:
        webhook_pb2.WebhookPluginInfo: gRPC ì›¹í›… í”ŒëŸ¬ê·¸ì¸ ì •ë³´
    """
    result['metadata'] = change_struct_type(result['metadata'])  # dict â†’ Struct ë³€í™˜
    return webhook_pb2.WebhookPluginInfo(**result)
```

#### common_info.py - ê³µí†µ gRPC ì‘ë‹µ
```python
from google.protobuf.empty_pb2 import Empty

def EmptyInfo():
    """ë¹ˆ ì‘ë‹µ ìƒì„±
    
    Returns:
        Empty: gRPC ë¹ˆ ë©”ì‹œì§€
    """
    return Empty()
```

### 8. ì˜ˆì™¸ ì²˜ë¦¬ ë ˆì´ì–´ (error/)

#### event.py - ì´ë²¤íŠ¸ ê´€ë ¨ ì˜ˆì™¸
```python
from spaceone.core.error import *

class ERROR_REQUIRED_FIELDS(ERROR_BASE):
    """í•„ìˆ˜ í•„ë“œ ëˆ„ë½ ì˜¤ë¥˜"""
    _message = 'Required field is missing(field= {field})'

class ERROR_CHECK_VALIDITY(ERROR_BASE):
    """ì´ë²¤íŠ¸ ëª¨ë¸ ê²€ì¦ ì˜¤ë¥˜"""
    _message = 'Event model is not validate (field= {field})'

class ERROR_PARSE_EVENT(ERROR_BASE):
    """ì´ë²¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜"""
    _message = 'Failed to parse event'

class ERROR_CONVERT_DATA_TYPE(ERROR_BASE):
    """ë°ì´í„° íƒ€ì… ë³€í™˜ ì˜¤ë¥˜"""
    _message = 'Failed to convert data type'
```

#### webhook.py - ì›¹í›… ê´€ë ¨ ì˜ˆì™¸
```python
from spaceone.core.error import *

# í˜„ì¬ ì›¹í›… ê´€ë ¨ ì˜ˆì™¸ëŠ” ì •ì˜ë˜ì§€ ì•ŠìŒ
# TODO: OCI ì›¹í›… íŠ¹í™” ì˜ˆì™¸ í´ë˜ìŠ¤ ì¶”ê°€ í•„ìš”
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ êµ¬ì¡° ë¶„ì„

### í…ŒìŠ¤íŠ¸ ì„¤ì •

#### config.yml - í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
```yaml
GLOBAL:
  SERVICE: monitoring                    # ì„œë¹„ìŠ¤ëª…
  ENDPOINTS:
    monitoring:
      plugin: localhost:50051           # í”ŒëŸ¬ê·¸ì¸ gRPC ì—”ë“œí¬ì¸íŠ¸
```

#### scenario.json - í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
```json
{}  # í˜„ì¬ ë¹„ì–´ìˆìŒ (TODO: í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì¶”ê°€ í•„ìš”)
```

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

#### test_webhook_api.py - ì›¹í›… API í…ŒìŠ¤íŠ¸
```python
import logging
from spaceone.tester import TestCase, print_json

class TestWebhook(TestCase):
    """ì›¹í›… API í…ŒìŠ¤íŠ¸"""

    def test_init(self):
        """ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸"""
        v_info = self.monitoring.Webhook.init({'options': {}})
        print_json(v_info)

    def test_verify(self):
        """ê²€ì¦ í…ŒìŠ¤íŠ¸"""
        self.monitoring.Webhook.verify({'options': {}})
```

#### test_event_test.py - ê¸°ë³¸ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸
```python
class TestEvent(TestCase):
    """ê¸°ë³¸ ì´ë²¤íŠ¸ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸"""

    def test_version(self):
        """ë²„ì „ 'test' ì´ë²¤íŠ¸ íŒŒì‹± í…ŒìŠ¤íŠ¸"""
        data = {
            "version": "test",
            "incident": {
                "incident_id": "12345",
                "state": "OPEN",
                "summary": "Test Incident",
                # ... ê¸°íƒ€ í…ŒìŠ¤íŠ¸ ë°ì´í„°
            }
        }
        
        parsed_data = self.monitoring.Event.parse({'options': {}, 'data': data})
        results = to_json(parsed_data)
        
        for result in results['results']:
            self.assertEqual(result['event_type'], 'ALERT')
```

#### test_event_1_2.py - ë²„ì „ 1.2 ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸
```python
class TestEvent(TestCase):
    """ë²„ì „ 1.2 ì´ë²¤íŠ¸ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸"""

    def test_version_1_2_event_type_open(self):
        """OPEN ìƒíƒœ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸"""
        data = {
            "version": "1.2",
            "incident": {
                "state": "open",
                # ... Google Cloud ì‹¤ì œ ë°ì´í„° êµ¬ì¡°
            }
        }
        
        parsed_data = self.monitoring.Event.parse({'options': {}, 'data': data})
        # ê²°ê³¼ ê²€ì¦

    def test_version_1_2_event_type_close(self):
        """CLOSED ìƒíƒœ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸"""
        data = {
            "version": "1.2", 
            "incident": {
                "state": "closed",
                # ... Google Cloud ì‹¤ì œ ë°ì´í„° êµ¬ì¡°
            }
        }
        
        parsed_data = self.monitoring.Event.parse({'options': {}, 'data': data})
        # RECOVERY íƒ€ì… ê²€ì¦
```

## ğŸ³ ë°°í¬ ë° ë¹Œë“œ êµ¬ì¡°

### Dockerfile ë¶„ì„
```dockerfile
FROM cloudforet/python-core:1           # SpaceONE ê¸°ë³¸ ì´ë¯¸ì§€

ENV PYTHONUNBUFFERED 1                  # Python ì¶œë ¥ ë²„í¼ë§ ë¹„í™œì„±í™”
ENV SPACEONE_PORT 50051                 # gRPC í¬íŠ¸
ENV SERVER_TYPE grpc                    # ì„œë²„ íƒ€ì…
ENV PKG_DIR /tmp/pkg                    # íŒ¨í‚¤ì§€ ë””ë ‰í† ë¦¬
ENV SRC_DIR /tmp/src                    # ì†ŒìŠ¤ ë””ë ‰í† ë¦¬

# ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
RUN apt update && apt upgrade -y

# Python ì˜ì¡´ì„± ì„¤ì¹˜
COPY pkg/*.txt ${PKG_DIR}/
RUN pip install --upgrade pip && \
    pip install --upgrade --use-deprecated=legacy-resolver -r ${PKG_DIR}/pip_requirements.txt && \
    pip install --upgrade spaceone-api

# ì†ŒìŠ¤ì½”ë“œ ë³µì‚¬ ë° ì„¤ì¹˜
COPY src ${SRC_DIR}
WORKDIR ${SRC_DIR}
RUN python3 setup.py install

# í¬íŠ¸ ë…¸ì¶œ ë° ì‹¤í–‰
EXPOSE ${SPACEONE_PORT}
ENTRYPOINT ["spaceone"]
CMD ["grpc", "spaceone.monitoring"]     # gRPC ì„œë²„ë¡œ ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ ì‹¤í–‰
```

### Makefile ë¶„ì„
```makefile
# í™˜ê²½ ë³€ìˆ˜
export WS_ROOT=$(shell pwd)             # ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë£¨íŠ¸
export PLUGIN=$(notdir $(CURDIR))       # í”ŒëŸ¬ê·¸ì¸ëª… (ë””ë ‰í† ë¦¬ëª…)

# Docker ì´ë¯¸ì§€ ë¹Œë“œ
build:
	docker build -t debug/${PLUGIN} . $(CACHE)

# ë””ë²„ê·¸ ëª¨ë“œ ì‹¤í–‰
debug: build
	docker run -ti --name ${PLUGIN} -v ${WS_ROOT}:/opt debug/${PLUGIN}

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
test: build
	docker run -d --name ${PLUGIN} -v ${WS_ROOT}:/opt debug/${PLUGIN}
	docker exec ${PLUGIN} bash -c "cd /opt/test/api; spaceone test -c config.yml -s scenario.json"

# ì •ë¦¬
clean:
	docker rm -f ${PLUGIN}
```

## ğŸ” ì½”ë“œ í’ˆì§ˆ ë° ê°œì„  ì‚¬í•­

### í˜„ì¬ ìƒíƒœ ë¶„ì„

#### âœ… ì˜ êµ¬í˜„ëœ ë¶€ë¶„
1. **SpaceONE í‘œì¤€ ì•„í‚¤í…ì²˜**: ê³„ì¸µë³„ ë¶„ë¦¬ê°€ ì˜ ë˜ì–´ ìˆìŒ
2. **gRPC ì¸í„°í˜ì´ìŠ¤**: í‘œì¤€ íŒ¨í„´ ì¤€ìˆ˜
3. **ë°ì´í„° ê²€ì¦**: Schematics ëª¨ë¸ í™œìš©
4. **ì˜ˆì™¸ ì²˜ë¦¬**: êµ¬ì¡°í™”ëœ ì˜¤ë¥˜ í´ë˜ìŠ¤
5. **í…ŒìŠ¤íŠ¸ êµ¬ì¡°**: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ êµ¬ì¶•

#### âš ï¸ ê°œì„  í•„ìš” ì‚¬í•­

1. **ëª…ëª… ì¼ê´€ì„± ë¬¸ì œ**
   ```python
   # í˜„ì¬: Google ê´€ë ¨ ëª…ëª…
   name='plugin-google-monitoring-mon-webhook'
   'GoogleCloudConnector': {}
   
   # ê°œì„  í•„ìš”: OCI ê´€ë ¨ ëª…ëª…ìœ¼ë¡œ ë³€ê²½
   name='plugin-oci-monitoring-mon-webhook'
   'OCIConnector': {}
   ```

2. **ë¯¸ì™„ì„± êµ¬í˜„**
   ```python
   # webhook_service.py
   def verify(self, params):
       pass  # TODO: OCI ê²€ì¦ ë¡œì§ êµ¬í˜„ í•„ìš”
   
   # incident.py  
   def _update_occurred_at(self):
       timestamp  # TODO: ì™„ì„±ë˜ì§€ ì•Šì€ ì½”ë“œ
   ```

3. **OCI íŠ¹í™” ë¡œì§ ë¶€ì¬**
   - í˜„ì¬ Google Cloud ë°ì´í„° êµ¬ì¡°ì— ë§ì¶°ì ¸ ìˆìŒ
   - OCI Notification Service êµ¬ì¡°ì— ë§ëŠ” íŒŒì‹± ë¡œì§ í•„ìš”
   - OCI ë©”ì‹œì§€ ì„œëª… ê²€ì¦ ë¡œì§ í•„ìš”

4. **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¶€ì¡±**
   ```json
   // scenario.json
   {}  // ë¹ˆ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
   ```

5. **ë¬¸ì„œí™” ë¶€ì¡±**
   - ì½”ë“œ ì£¼ì„ ë¶€ì¡±
   - API ë¬¸ì„œ ë¶€ì¡±
   - ê°œë°œì ê°€ì´ë“œ ë¶€ì¡±

### ê¶Œì¥ ê°œì„  ë°©í–¥

#### 1. OCI íŠ¹í™” êµ¬í˜„
```python
# ìƒˆë¡œìš´ OCI ì¸ì‹œë˜íŠ¸ ì²˜ë¦¬ê¸° í•„ìš”
class IncidentOCI(Incident):
    """OCI Monitoring ì•ŒëŒ ì²˜ë¦¬"""
    
    def __init__(self, notification_data, version):
        # OCI Notification Service êµ¬ì¡°ì— ë§ëŠ” íŒŒì‹±
        pass
    
    def _parse_oci_message(self):
        # OCI ë©”ì‹œì§€ JSON íŒŒì‹±
        pass
    
    def _verify_signature(self):
        # OCI ë””ì§€í„¸ ì„œëª… ê²€ì¦
        pass
```

#### 2. ì„¤ì • ì—…ë°ì´íŠ¸
```python
# global_conf.py ê°œì„ 
CONNECTORS = {
    'OCIConnector': {
        'signature_verification': True,
        'supported_regions': ['ap-seoul-1', 'ap-tokyo-1', ...],
        'timeout': 30
    }
}
```

#### 3. í…ŒìŠ¤íŠ¸ ê°•í™”
```json
// scenario.json ê°œì„ 
{
  "test_cases": [
    {
      "name": "OCI_Notification_FIRING",
      "input": {...},
      "expected": {...}
    },
    {
      "name": "OCI_Notification_OK", 
      "input": {...},
      "expected": {...}
    }
  ]
}
```

## ğŸ“Š ì˜ì¡´ì„± ë° í˜¸í™˜ì„±

### í•µì‹¬ ì˜ì¡´ì„±
```
spaceone-api     # SpaceONE í”Œë«í¼ API
schematics       # ë°ì´í„° ëª¨ë¸ ê²€ì¦
```

### Python í˜¸í™˜ì„±
- **Python 3.x** ê¸°ë°˜
- **gRPC** í†µì‹ 
- **Protocol Buffers** ë©”ì‹œì§€ í˜•ì‹

### SpaceONE í”Œë«í¼ í˜¸í™˜ì„±
- **SpaceONE Core** ê¸°ë°˜
- **CloudForet** ìƒíƒœê³„ í˜¸í™˜
- **í‘œì¤€ í”ŒëŸ¬ê·¸ì¸ ì•„í‚¤í…ì²˜** ì¤€ìˆ˜

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„ ê°œë°œ ê°€ì´ë“œ

### 1. OCI ì—°ë™ êµ¬í˜„
1. `IncidentOCI` í´ë˜ìŠ¤ êµ¬í˜„
2. OCI ë©”ì‹œì§€ ì„œëª… ê²€ì¦ ë¡œì§ ì¶”ê°€
3. OCI êµ¬ë… í™•ì¸ ì²˜ë¦¬ ë¡œì§ êµ¬í˜„

### 2. í…ŒìŠ¤íŠ¸ ê°•í™”
1. OCI ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
2. í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ êµ¬í˜„
3. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì¶”ê°€

### 3. ë¬¸ì„œí™” ì™„ì„±
1. API ë¬¸ì„œ ìë™ ìƒì„±
2. ê°œë°œì ê°€ì´ë“œ ì‘ì„±
3. ë°°í¬ ê°€ì´ë“œ ì—…ë°ì´íŠ¸

### 4. ì½”ë“œ í’ˆì§ˆ ê°œì„ 
1. ë¦°íŒ… ê·œì¹™ ì ìš©
2. íƒ€ì… íŒíŠ¸ ì¶”ê°€
3. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ í–¥ìƒ

---

**ë¬¸ì„œ ë²„ì „**: 1.0.0  
**ë¶„ì„ ì¼ì**: 2024ë…„ 1ì›” 28ì¼  
**ë¶„ì„ ëŒ€ìƒ**: plugin-oci-monitoring-mon-webhook v0.1.3
