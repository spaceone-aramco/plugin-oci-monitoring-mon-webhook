# 서버 디버그 로그 명세서

## 개요

이 문서는 OCI Monitoring Webhook 플러그인의 테스트 실행 시 생성되는 서버 디버그 로그(`server_debug.log`)의 구조와 내용을 상세히 설명합니다. 개선된 로깅 시스템은 **JSON 형태의 REQUEST 로그**를 포함하여 구조화된 입력 데이터와 처리 결과를 모두 추적할 수 있습니다.

## 로그 파일 구조

### 1. 기본 정보

```
=== OCI Monitoring Webhook 플러그인 테스트 로그 ===
테스트 시작 시간: 2025-10-19 21:40:04
Python 버전: Python 3.13.5
PYTHONPATH: /Users/mz01-sts/IdeaProjects/plugin-oci-monitoring-mon-webhook/src:
테스트 방식: 직접 Python 코드 실행 (gRPC 서버 불필요)
=================================================
```

### 2. 로그 레벨 및 태그

| 태그 | 설명 | 용도 |
|------|------|------|
| `[INFO]` | 일반 정보 | 테스트 진행 상황, 환경 정보 |
| `[TEST]` | 테스트 시작 | 각 테스트 케이스 시작 시점 |
| `[REQUEST]` | **요청 데이터** | **입력 데이터 상세 정보** |
| `[SUCCESS]` | 성공 결과 | 테스트 성공 및 결과 |
| `[DETAIL]` | 상세 정보 | 처리 결과의 세부 사항 |
| `[SUMMARY]` | 요약 정보 | 테스트 완료 후 통계 |
| `[ERROR]` | 오류 정보 | 테스트 실패 시 오류 내용 |

## 테스트별 로그 구조

### 1. Webhook.init 테스트

```
[2025-10-19 21:44:38] [TEST] Webhook.init 테스트 시작
[2025-10-19 21:44:38] [REQUEST] {
  "test_type": "webhook_init",
  "description": "플러그인 정보 초기화",
  "method": "Webhook.init",
  "input_parameters": {},
  "expected_output": {
    "plugin_id": "plugin-oci-monitoring-webhook",
    "version": "1.0.0",
    "supported_providers": ["oracle"]
  }
}
[2025-10-19 21:44:38] [SUCCESS] Webhook.init 테스트 성공
[2025-10-19 21:44:38] [DETAIL] 플러그인 ID: plugin-oci-monitoring-webhook
[2025-10-19 21:44:38] [DETAIL] 버전: 1.0.0
[2025-10-19 21:44:38] [DETAIL] 지원 제공자: ['oracle']
```

**JSON REQUEST 구조**:
- `test_type`: 테스트 유형 식별자
- `description`: 테스트 설명
- `method`: 호출되는 메서드명
- `input_parameters`: 입력 매개변수 (빈 객체)
- `expected_output`: 예상 출력 구조

### 2. Webhook.verify 테스트 (OCI Notification)

```
[2025-10-19 21:44:38] [TEST] Webhook.verify (OCI Notification) 테스트 시작
[2025-10-19 21:44:38] [REQUEST] {
  "test_type": "webhook_verify_notification",
  "description": "OCI Notification 메시지 검증",
  "method": "Webhook.verify",
  "input_data": {
    "message_type": "Notification",
    "message_id": "12345678-1234-1234-1234-123456789012",
    "topic_arn": "oci:ons:us-ashburn-1:ocid1.tenancy.oc1..aaaaaaaaexample:monitoring-alerts",
    "subject": "OCI Monitoring Alarm - High CPU Usage",
    "region": "us-ashburn-1",
    "timestamp": "2024-01-28T10:30:00.000Z",
    "signature_version": "1",
    "signature": "example-signature-hash",
    "signing_cert_url": "https://cell-1.notification.us-ashburn-1.oci.oraclecloud.com/20181201/certificate",
    "unsubscribe_url": "https://cell-1.notification.us-ashburn-1.oci.oraclecloud.com/20181201/subscription/example"
  },
  "validation_criteria": {
    "required_fields": ["Type", "MessageId", "Message"],
    "expected_type": "Notification"
  }
}
[2025-10-19 21:44:38] [SUCCESS] Webhook.verify 테스트 성공
```

**JSON REQUEST 구조**:
- `test_type`: `webhook_verify_notification`
- `input_data`: OCI Notification 메시지의 모든 필드
- `validation_criteria`: 검증 조건 (필수 필드, 예상 타입)

### 3. Webhook.verify 테스트 (구독 확인)

```
[2025-10-19 21:40:04] [TEST] Webhook.verify (구독 확인) 테스트 시작
[2025-10-19 21:40:04] [REQUEST] OCI SubscriptionConfirmation 메시지:
[2025-10-19 21:40:04] [REQUEST]   - Type: SubscriptionConfirmation
[2025-10-19 21:40:04] [REQUEST]   - MessageId: 12345678-1234-1234-1234-123456789014
[2025-10-19 21:40:04] [REQUEST]   - SubscribeURL: https://cell-1.notification.us-ashburn-1.oci.oracl...
[2025-10-19 21:40:04] [REQUEST]   - Region: us-ashburn-1
[2025-10-19 21:40:04] [SUCCESS] Webhook.verify (구독 확인) 테스트 성공
```

**REQUEST 로그 특징**:
- `SubscribeURL`: 구독 확인 URL (보안상 50자로 제한)
- 구독 확인 메시지 전용 필드 포함

### 4. Event.parse 테스트 (핵심 기능)

#### 4.1. OCI 알람 메시지 처리

```
[2025-10-19 21:44:39] [TEST] 시나리오 1: FIRING 알람 (High CPU Usage) 시작
[2025-10-19 21:44:39] [REQUEST] {
  "test_type": "event_parse_oci",
  "scenario": "FIRING 알람 (High CPU Usage)",
  "description": "OCI Notification 메시지 파싱",
  "method": "Event.parse",
  "input_data": {
    "message_type": "Notification",
    "message_id": "12345678-1234-1234-1234-123456789012",
    "topic_arn": "oci:ons:us-ashburn-1:ocid1.tenancy.oc1..aaaaaaaaexample:monitoring-alerts",
    "subject": "OCI Monitoring Alarm - High CPU Usage",
    "region": "us-ashburn-1",
    "timestamp": "2024-01-28T10:30:00.000Z",
    "alarm_info": {
      "alarm_id": "ocid1.alarm.oc1.iad.aaaaaaaaexample",
      "alarm_state": "FIRING",
      "previous_state": "OK",
      "display_name": "High CPU Usage Alert",
      "severity": "WARNING",
      "namespace": "oci_computeagent",
      "compartment_id": "ocid1.compartment.oc1..aaaaaaaaexample",
      "body": "CPU utilization exceeded 80% threshold for instance web-server-01",
      "timestamp": "2024-01-28T10:30:00.000Z"
    }
  }
}
[2025-10-19 21:44:39] [SUCCESS] 시나리오 1: FIRING 알람 (High CPU Usage) 성공
[2025-10-19 21:44:39] [DETAIL] Event Type: ALERT
[2025-10-19 21:44:39] [DETAIL] Title: High CPU Usage Alert (open)
[2025-10-19 21:44:39] [DETAIL] Severity: WARNING
[2025-10-19 21:44:39] [DETAIL] Resource: High CPU Usage Alert
[2025-10-19 21:44:39] [DETAIL] Event Key: ocid1.alarm.oc1.iad.aaaaaaaaexample
```

**JSON REQUEST 구조**:
- `test_type`: `event_parse_oci`
- `scenario`: 테스트 시나리오명
- `input_data`: 구조화된 입력 데이터
  - **기본 필드**: message_type, message_id, subject, region
  - **alarm_info**: 자동 파싱된 알람 상세 정보 (JSON 객체)

#### 4.2. Google Cloud 호환성 테스트

```
[2025-10-19 21:44:39] [TEST] 시나리오 6: Google Cloud 호환성 테스트 시작
[2025-10-19 21:44:39] [REQUEST] {
  "test_type": "event_parse_google_cloud",
  "scenario": "Google Cloud 호환성 테스트",
  "description": "Google Cloud Monitoring 메시지 파싱",
  "method": "Event.parse",
  "input_data": {
    "version": "test",
    "incident_id": "0.mtdi83m6w8ao",
    "condition_name": "VM Instance - CPU utilization",
    "state": "open",
    "summary": "CPU utilization for test VM Instance is above the threshold of 0.500 with a value of 0.790.",
    "policy_name": "test-server-cpu-alert-policy",
    "resource_id": "test-instance-id",
    "resource_name": "test-vm-instance",
    "started_at": 1675315787,
    "url": "https://console.cloud.google.com/monitoring/alerting/incidents/0.mtdi83m6w8ao"
  }
}
[2025-10-19 21:44:39] [SUCCESS] 시나리오 6: Google Cloud 호환성 테스트 성공
```

**JSON REQUEST 구조**:
- `test_type`: `event_parse_google_cloud`
- `input_data`: Google Cloud incident 데이터의 모든 필드
  - **메타데이터**: version, incident_id, condition_name
  - **상태 정보**: state, summary, policy_name
  - **리소스 정보**: resource_id, resource_name, url

## 로그 분석 가이드

### 1. 입력-출력 추적

각 테스트 시나리오에서 **JSON REQUEST → DETAIL** 순서로 로그를 확인하여 구조화된 입력 데이터가 어떻게 변환되는지 추적할 수 있습니다.

**JSON REQUEST 로그 검색 명령어**:
```bash
# JSON REQUEST 로그 검색 (jq 사용 권장)
grep -A 20 '\[REQUEST\] {' server_debug.log | jq '.'

# OCI 메시지 타입별 REQUEST 로그 검색
grep -A 20 '"test_type": "event_parse_oci"' server_debug.log

# Google Cloud 메시지 REQUEST 로그 검색
grep -A 20 '"test_type": "event_parse_google_cloud"' server_debug.log

# 특정 시나리오의 REQUEST 로그 검색
grep -A 20 '"scenario": "FIRING 알람"' server_debug.log
```

**예시: OCI FIRING 알람 JSON 추적**
```
INPUT  [REQUEST] {"alarm_info": {"alarm_state": "FIRING", "severity": "WARNING"}}
OUTPUT [DETAIL]  Event Type: ALERT, Severity: WARNING
```

**예시: OCI OK 알람 JSON 추적**  
```
INPUT  [REQUEST] {"alarm_info": {"alarm_state": "OK", "severity": "INFO"}}
OUTPUT [DETAIL]  Event Type: RECOVERY, Severity: INFO
```

### 2. 데이터 변환 규칙 확인

로그를 통해 다음 변환 규칙을 확인할 수 있습니다:

#### 2.1. 상태 매핑
- `FIRING` → `ALERT` (Event Type)
- `OK` → `RECOVERY` (Event Type)

#### 2.2. 심각도 처리
- OCI severity 그대로 유지: `WARNING`, `CRITICAL`, `ERROR`
- 복구 시 `INFO`로 변경: `OK` 상태일 때

#### 2.3. 필드 누락 처리
```
[REQUEST] Severity: N/A          # 원본에 severity 없음
[DETAIL]  Severity: WARNING      # 기본값 WARNING 적용
```

### 3. 오류 진단

#### 3.1. JSON 파싱 오류
```
[REQUEST] Message: (JSON 파싱 실패)
```

#### 3.2. 필수 필드 누락
REQUEST 로그에서 `N/A` 값이 나타나면 원본 데이터에 해당 필드가 없음을 의미합니다.

## 로그 활용 방안

### 1. 개발 및 디버깅

- **입력 데이터 검증**: REQUEST 로그로 실제 입력 데이터 확인
- **변환 로직 검증**: REQUEST → DETAIL 비교로 변환 규칙 확인
- **오류 원인 분석**: 파싱 실패나 필드 누락 원인 파악

### 2. 테스트 검증

- **시나리오별 추적**: 각 테스트 시나리오의 입출력 완전 추적
- **성능 분석**: 타임스탬프로 처리 시간 측정
- **커버리지 확인**: 다양한 OCI 서비스 및 상태 테스트 확인

### 3. 운영 모니터링

- **실제 데이터 분석**: 프로덕션 환경의 실제 OCI 메시지 구조 파악
- **변환 품질 확인**: 입력 데이터 대비 출력 데이터 품질 검증
- **호환성 검증**: OCI와 Google Cloud 메시지 모두 정상 처리 확인

## 로그 파일 위치 및 관리

### 파일 경로
```
test_results_YYYYMMDD_HHMMSS/server_debug.log
```

### 파일 크기 및 보관
- **평균 크기**: 150줄 내외 (6개 시나리오 기준)
- **보관 정책**: 테스트 실행 시마다 새 디렉토리 생성
- **정리 방법**: 테스트 시작 시 이전 결과 자동 정리

### 로그 레벨 설정
```python
# 더 상세한 로깅이 필요한 경우
import logging
logging.getLogger('spaceone.monitoring').setLevel(logging.DEBUG)
```

## 개선 사항 (v2.0)

### 추가된 기능
1. **REQUEST 로깅**: 모든 입력 데이터 상세 기록
2. **JSON 자동 파싱**: OCI Message 필드 자동 파싱 및 표시
3. **메시지 타입별 로깅**: OCI vs Google Cloud 구분 로깅
4. **보안 고려**: 민감한 URL은 50자로 제한 표시

### 이전 버전 대비 개선점
- **가시성 향상**: 입력 데이터를 명확히 볼 수 있음
- **디버깅 효율성**: 문제 발생 시 원인 파악 용이
- **테스트 검증**: 입출력 매핑 관계 명확히 확인 가능
- **문서화**: 실제 데이터 구조 파악 및 문서화 지원

---

**문서 버전**: 3.0  
**최종 업데이트**: 2025-10-19  
**기반 로그**: `test_results_20251019_214438/server_debug.log`  
**주요 개선**: JSON 형태 REQUEST 로깅, 구조화된 데이터 분석 지원, jq 호환성
